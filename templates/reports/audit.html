{% extends "base.html" %}

{% block title %}Audit Reports - School Inventory System{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col">
        <h2><i class="bi bi-shield-check"></i> Audit</h2>
        <p class="text-muted mb-0">Audit-ready snapshots and overdue audit sweeps.</p>
    </div>
</div>

<div class="card mb-4">
    <div class="card-header">
        <h5 class="mb-0">Audit-Ready Snapshot</h5>
    </div>
    <div class="card-body">
        <p class="text-muted">
            Generates a timestamped ZIP with manifest + hashes:
            <code>manifest.json</code>, <code>manifest.sha256</code>, <code>current_assignments.csv</code>,
            <code>assets.csv</code>, <code>repairs.csv</code>, <code>assignment_events.csv</code>, <code>users.csv</code>, <code>README.txt</code>.
        </p>

        <form method="POST" action="{{ url_for('reports.generate_audit_snapshot') }}" class="row g-3 align-items-end mb-3">
            <div class="col-md-3">
                <label for="snapshot_delivery_method" class="form-label">Delivery</label>
                <select class="form-select" id="snapshot_delivery_method" name="snapshot_delivery_method" required>
                    <option value="download">Download</option>
                    <option value="email">Email</option>
                </select>
            </div>
            <div class="col-md-5 d-none" id="snapshot_email_group">
                <label for="snapshot_email_to" class="form-label">Email Address</label>
                <input type="email" class="form-control" id="snapshot_email_to" name="snapshot_email_to" placeholder="name@school.edu">
            </div>
            <div class="col-md-4">
                <button type="submit" class="btn btn-primary">
                    <i class="bi bi-file-zip"></i> Generate Snapshot Now
                </button>
            </div>
        </form>

        {% if current_user.role == 'admin' %}
        <hr>
        <h6>Scheduled Auto-Email</h6>
        <form method="POST" action="{{ url_for('reports.update_audit_snapshot_schedule') }}" class="row g-3">
            <div class="col-md-12">
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="snapshot_schedule_enabled" name="snapshot_schedule_enabled" {% if snapshot_schedule.enabled %}checked{% endif %}>
                    <label class="form-check-label" for="snapshot_schedule_enabled">Enable scheduled snapshots</label>
                </div>
            </div>
            <div class="col-md-4">
                <label for="snapshot_schedule_email" class="form-label">Recipient Email</label>
                <input type="email" class="form-control" id="snapshot_schedule_email" name="snapshot_schedule_email"
                       value="{{ snapshot_schedule.recipient_email or '' }}" placeholder="name@school.edu">
            </div>
            <div class="col-md-2">
                <label for="snapshot_schedule_frequency" class="form-label">Frequency</label>
                <select class="form-select" id="snapshot_schedule_frequency" name="snapshot_schedule_frequency">
                    <option value="daily" {% if snapshot_schedule.frequency == 'daily' %}selected{% endif %}>Daily</option>
                    <option value="weekly" {% if snapshot_schedule.frequency == 'weekly' %}selected{% endif %}>Weekly</option>
                </select>
            </div>
            <div class="col-md-2">
                <label for="snapshot_schedule_hour_utc" class="form-label">Hour (UTC)</label>
                <input type="number" class="form-control" id="snapshot_schedule_hour_utc" name="snapshot_schedule_hour_utc"
                       min="0" max="23" value="{{ snapshot_schedule.hour_utc }}">
            </div>
            <div class="col-md-2">
                <label for="snapshot_schedule_minute_utc" class="form-label">Minute (UTC)</label>
                <input type="number" class="form-control" id="snapshot_schedule_minute_utc" name="snapshot_schedule_minute_utc"
                       min="0" max="59" value="{{ snapshot_schedule.minute_utc }}">
            </div>
            <div class="col-md-2">
                <label for="snapshot_schedule_weekday_utc" class="form-label">Weekday (UTC)</label>
                <select class="form-select" id="snapshot_schedule_weekday_utc" name="snapshot_schedule_weekday_utc">
                    <option value="0" {% if snapshot_schedule.weekday_utc == 0 %}selected{% endif %}>Mon</option>
                    <option value="1" {% if snapshot_schedule.weekday_utc == 1 %}selected{% endif %}>Tue</option>
                    <option value="2" {% if snapshot_schedule.weekday_utc == 2 %}selected{% endif %}>Wed</option>
                    <option value="3" {% if snapshot_schedule.weekday_utc == 3 %}selected{% endif %}>Thu</option>
                    <option value="4" {% if snapshot_schedule.weekday_utc == 4 %}selected{% endif %}>Fri</option>
                    <option value="5" {% if snapshot_schedule.weekday_utc == 5 %}selected{% endif %}>Sat</option>
                    <option value="6" {% if snapshot_schedule.weekday_utc == 6 %}selected{% endif %}>Sun</option>
                </select>
            </div>
            <div class="col-12">
                <button type="submit" class="btn btn-outline-primary">
                    <i class="bi bi-calendar-check"></i> Save Snapshot Schedule
                </button>
            </div>
        </form>
        {% endif %}
    </div>
</div>

<div class="card mb-4">
    <div class="card-header">
        <h5 class="mb-0">Snapshot History</h5>
    </div>
    <div class="card-body">
        {% if snapshot_logs %}
        <div class="table-responsive">
            <table class="table table-sm">
                <thead>
                    <tr>
                        <th>Generated</th>
                        <th>Trigger</th>
                        <th>Delivery</th>
                        <th>Recipient</th>
                        <th>Manifest SHA256</th>
                        <th>Status</th>
                        <th>Message</th>
                    </tr>
                </thead>
                <tbody>
                    {% for log in snapshot_logs %}
                    <tr>
                        <td><small>{{ log.generated_at.strftime('%Y-%m-%d %H:%M:%S') }}</small></td>
                        <td>{{ log.trigger_type }}</td>
                        <td>{{ log.delivery_method }}</td>
                        <td>{{ log.recipient_email or '-' }}</td>
                        <td><code>{{ log.manifest_sha256[:16] }}...</code></td>
                        <td>
                            {% if log.status == 'success' %}
                            <span class="badge bg-success">Success</span>
                            {% else %}
                            <span class="badge bg-danger">Failed</span>
                            {% endif %}
                        </td>
                        <td><small>{{ log.message or '-' }}</small></td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <p class="text-muted mb-0">No snapshot runs yet.</p>
        {% endif %}
    </div>
</div>

<div class="card mb-4">
    <div class="card-header">
        <h5 class="mb-0">Overdue Audit Sweep</h5>
    </div>
    <div class="card-body">
        <form method="POST" action="{{ url_for('reports.generate_overdue_sweep') }}" class="row g-3 align-items-end mb-3">
            <div class="col-md-3">
                <label for="period_type" class="form-label">Period</label>
                <select class="form-select" id="period_type" name="period_type">
                    <option value="monthly">Monthly</option>
                    <option value="quarterly">Quarterly</option>
                </select>
            </div>
            <div class="col-md-4">
                <button type="submit" class="btn btn-primary">
                    <i class="bi bi-list-check"></i> Generate Audit List
                </button>
            </div>
        </form>

        {% if recent_sweeps %}
        <form method="GET" action="{{ url_for('reports.audit') }}" class="row g-2 align-items-end mb-3">
            <div class="col-md-6">
                <label for="sweep_id" class="form-label">View Sweep</label>
                <select class="form-select" id="sweep_id" name="sweep_id" onchange="this.form.submit()">
                    {% for sweep in recent_sweeps %}
                    <option value="{{ sweep.id }}" {% if selected_sweep and sweep.id == selected_sweep.id %}selected{% endif %}>
                        #{{ sweep.id }} | {{ sweep.period_label }} | {{ sweep.status|title }} | {{ sweep.generated_at.strftime('%Y-%m-%d %H:%M') }}
                    </option>
                    {% endfor %}
                </select>
            </div>
        </form>
        {% endif %}

        {% if selected_sweep %}
        <div class="alert alert-info">
            Sweep #{{ selected_sweep.id }} ({{ selected_sweep.period_label }}) -
            Verified: {{ sweep_verified_count }} |
            Pending: {{ sweep_pending_count }} |
            Status: {{ selected_sweep.status|title }}
            {% if selected_sweep.completed_at %}
            | Completed: {{ selected_sweep.completed_at.strftime('%Y-%m-%d %H:%M') }}
            {% endif %}
            <a class="btn btn-sm btn-outline-primary ms-2" href="{{ url_for('reports.download_overdue_sweep_csv', sweep_id=selected_sweep.id) }}">
                Download List CSV
            </a>
        </div>

        <form method="POST" action="{{ url_for('reports.scan_overdue_sweep_item', sweep_id=selected_sweep.id) }}" class="row g-2 align-items-end mb-3">
            <div class="col-md-6">
                <label for="scanned_input" class="form-label">Scan / Enter Asset Tag</label>
                <input type="text" class="form-control" id="scanned_input" name="scanned_input" placeholder="e.g., LT001" autofocus>
            </div>
            <div class="col-md-3">
                <button type="submit" class="btn btn-success">
                    <i class="bi bi-upc-scan"></i> Confirm Scan
                </button>
            </div>
        </form>

        <div class="row g-3">
            <div class="col-lg-7">
                <h6>Audit List</h6>
                {% if selected_sweep_items %}
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Asset</th>
                                <th>Checked Out To</th>
                                <th>Due</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in selected_sweep_items %}
                            <tr>
                                <td>{{ item.asset_tag }} - {{ item.asset_name }}</td>
                                <td>{{ item.checked_out_to }}</td>
                                <td>{{ item.expected_return_date.strftime('%Y-%m-%d') if item.expected_return_date else '-' }}</td>
                                <td>
                                    {% if item.status == 'verified' %}
                                    <span class="badge bg-success">Verified</span>
                                    {% else %}
                                    <span class="badge bg-warning text-dark">Pending</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p class="text-muted mb-0">No items in this sweep.</p>
                {% endif %}
            </div>
            <div class="col-lg-5">
                <h6>Scan Log</h6>
                {% if selected_sweep_logs %}
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Time</th>
                                <th>Input</th>
                                <th>Result</th>
                                <th>By</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for log in selected_sweep_logs %}
                            <tr>
                                <td><small>{{ log.scanned_at.strftime('%Y-%m-%d %H:%M:%S') }}</small></td>
                                <td><code>{{ log.scanned_input }}</code></td>
                                <td>
                                    {% if log.matched %}
                                    <span class="badge bg-success">Matched</span>
                                    {% else %}
                                    <span class="badge bg-danger">No Match</span>
                                    {% endif %}
                                </td>
                                <td><small>{{ log.scanner.name if log.scanner else '-' }}</small></td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p class="text-muted mb-0">No scans logged yet.</p>
                {% endif %}
            </div>
        </div>
        {% else %}
        <p class="text-muted mb-0">No audit sweep yet. Generate one to start scanning.</p>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    function toggleEmailGroup(selectId, groupId, inputId) {
        const deliverySelect = document.getElementById(selectId);
        const group = document.getElementById(groupId);
        const input = document.getElementById(inputId);
        if (!deliverySelect || !group || !input) return;

        function syncVisibility() {
            const needsEmail = deliverySelect.value === 'email';
            group.classList.toggle('d-none', !needsEmail);
            input.required = needsEmail;
        }

        deliverySelect.addEventListener('change', syncVisibility);
        syncVisibility();
    }

    toggleEmailGroup('snapshot_delivery_method', 'snapshot_email_group', 'snapshot_email_to');

    const frequencySelect = document.getElementById('snapshot_schedule_frequency');
    const weekdayInput = document.getElementById('snapshot_schedule_weekday_utc');
    if (frequencySelect && weekdayInput) {
        function syncWeekdayVisibility() {
            const weekly = frequencySelect.value === 'weekly';
            weekdayInput.disabled = !weekly;
        }
        frequencySelect.addEventListener('change', syncWeekdayVisibility);
        syncWeekdayVisibility();
    }
</script>
{% endblock %}
