{% extends "base.html" %}

{% block title %}{% if user %}Edit User{% else %}Create User{% endif %} - School Inventory System{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{{ url_for('users.list_users') }}">Users</a></li>
                {% if user %}
                <li class="breadcrumb-item"><a href="{{ url_for('users.detail', user_id=user.id) }}">{{ user.name }}</a></li>
                <li class="breadcrumb-item active" aria-current="page">Edit</li>
                {% else %}
                <li class="breadcrumb-item active" aria-current="page">Create</li>
                {% endif %}
            </ol>
        </nav>
    </div>
</div>

<div class="row">
    <div class="col-md-8 offset-md-2">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    {% if user %}
                    <i class="bi bi-pencil"></i> Edit User: {{ user.name }}
                    {% else %}
                    <i class="bi bi-person-plus"></i> Create New User
                    {% endif %}
                </h5>
            </div>
            <div class="card-body">
                <form method="POST" autocomplete="off">
                    <!-- Name -->
                    <div class="mb-3">
                        <label for="name" class="form-label">Full Name <span class="text-danger">*</span></label>
                        <input type="text"
                               class="form-control"
                               id="name"
                               name="name"
                               value="{{ user.name if user else (prefill.name if prefill else '') }}"
                               required
                               autofocus>
                        <small class="form-text text-muted">First and last name</small>
                    </div>

                    <!-- Email -->
                    <div class="mb-3">
                        <label for="email" class="form-label">Email Address <span class="text-danger">*</span></label>
                        <input type="email"
                               class="form-control"
                               id="email"
                               name="email"
                               value="{{ user.email if user else (prefill.email if prefill else '') }}"
                               required>
                        <small class="form-text text-muted">Used for login and notifications</small>
                    </div>

                    <!-- Username -->
                    <div class="mb-3">
                        <label for="username" class="form-label">Username (Optional)</label>
                        <input type="text"
                               class="form-control"
                               id="username"
                               name="username"
                               value="{{ user.username if user else (prefill.username if prefill else '') }}">
                        <small class="form-text text-muted">Optional handle for internal reference</small>
                    </div>

                    <!-- Role -->
                    <div class="mb-3">
                        <label for="role" class="form-label">Role <span class="text-danger">*</span></label>
                        <select class="form-select" id="role" name="role" required>
                            <option value="student" {% if user and user.role == 'student' %}selected{% elif not user and prefill and prefill.role == 'student' %}selected{% endif %}>Student</option>
                            <option value="teacher" {% if user and user.role == 'teacher' %}selected{% elif not user and prefill and prefill.role == 'teacher' %}selected{% endif %}>Teacher</option>
                            <option value="staff" {% if user and user.role == 'staff' %}selected{% elif not user and prefill and prefill.role == 'staff' %}selected{% endif %}>Staff</option>
                            <option value="helpdesk" {% if user and user.role == 'helpdesk' %}selected{% elif not user and prefill and prefill.role == 'helpdesk' %}selected{% endif %}>Help Desk</option>
                            <option value="admin" {% if user and user.role == 'admin' %}selected{% elif not user and prefill and prefill.role == 'admin' %}selected{% endif %}>Admin</option>
                        </select>
                        <small class="form-text text-muted">
                            Determines user permissions - Admin full access, Help Desk can checkout/in and add users, Staff view-only, Teacher/Student no access
                        </small>
                    </div>

                    <!-- Asset Tag -->
                    <div class="mb-3">
                        <label for="asset_tag" class="form-label">Asset Tag (Optional)</label>
                        <input type="text"
                               class="form-control"
                               id="asset_tag"
                               name="asset_tag"
                               value="{{ user.asset_tag if user else (prefill.asset_tag if prefill else '') }}">
                        <small class="form-text text-muted">Optional assigned device tag (often used for students)</small>
                    </div>

                    <!-- Grade Level -->
                    <div class="mb-3">
                        <label for="grade_level" class="form-label">Grade Level (Optional)</label>
                        <input type="text"
                               class="form-control"
                               id="grade_level"
                               name="grade_level"
                               value="{{ user.grade_level if user else (prefill.grade_level if prefill else '') }}">
                        <small class="form-text text-muted">Examples: K, 3, 7, 10, 12</small>
                    </div>

                    <!-- Password -->
                    <div class="mb-3">
                        <label for="password" class="form-label">
                            Password
                        </label>
                        <input type="password"
                               class="form-control"
                               id="password"
                               name="password"
                               autocomplete="new-password">
                        <small class="form-text text-muted">
                            {% if user %}
                            Leave blank to keep current password
                            {% else %}
                            Optional: Student/teacher accounts will not be able to log in
                            {% endif %}
                        </small>
                    </div>

                    <!-- Profile Picture -->
                    <div class="mb-3">
                        <label for="profile_picture_url" class="form-label">Profile Picture URL (Optional)</label>
                        <input type="text"
                               class="form-control"
                               id="profile_picture_url"
                               name="profile_picture_url"
                               value="{{ user.profile_picture_url if user else (prefill.profile_picture_url if prefill else '') }}">
                    </div>

                    <!-- Default Theme -->
                    <div class="mb-3">
                        <label for="default_theme" class="form-label">Default Theme</label>
                        <select class="form-select" id="default_theme" name="default_theme">
                            <option value="light" {% if user and user.default_theme == 'light' %}selected{% elif not user and prefill and prefill.default_theme == 'light' %}selected{% endif %}>Light</option>
                            <option value="dark" {% if user and user.default_theme == 'dark' %}selected{% elif not user and prefill and prefill.default_theme == 'dark' %}selected{% endif %}>Dark</option>
                        </select>
                    </div>

                    {% if not user %}
                    <!-- Password Confirmation for New Users -->
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i>
                        <strong>New User Setup:</strong> The user will receive their login credentials.
                        They should change their password on first login.
                    </div>
                    {% endif %}

                    <!-- Buttons -->
                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <a href="{% if user %}{{ url_for('users.detail', user_id=user.id) }}{% else %}{{ url_for('users.list_users') }}{% endif %}"
                           class="btn btn-secondary">
                            <i class="bi bi-x"></i> Cancel
                        </a>
                        <button type="submit" class="btn btn-primary">
                            {% if user %}
                            <i class="bi bi-check-circle"></i> Update User
                            {% else %}
                            <i class="bi bi-person-plus"></i> Create User
                            {% endif %}
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Help Card -->
        <div class="card mt-3 bg-light">
            <div class="card-body">
                <h6><i class="bi bi-info-circle"></i> User Role Permissions</h6>
                <div class="row">
                    <div class="col-md-4">
                        <strong><span class="badge bg-secondary">Student</span></strong>
                        <ul class="small mt-2">
                            <li>No system access</li>
                            <li>Account for tracking only</li>
                        </ul>
                    </div>
                    <div class="col-md-4">
                        <strong><span class="badge bg-info">Teacher</span></strong>
                        <ul class="small mt-2">
                            <li>No system access</li>
                            <li>Account for tracking only</li>
                        </ul>
                    </div>
                    <div class="col-md-4">
                        <strong><span class="badge bg-primary">Help Desk</span></strong>
                        <ul class="small mt-2">
                            <li>Checkout/check-in</li>
                            <li>View assets/users/history</li>
                            <li>Create users</li>
                        </ul>
                    </div>
                </div>
                <div class="row mt-2">
                    <div class="col-md-4">
                        <strong><span class="badge bg-warning">Staff</span></strong>
                        <ul class="small mt-2">
                            <li>View assets/users/history</li>
                            <li>No checkouts</li>
                        </ul>
                    </div>
                    <div class="col-md-4">
                        <strong><span class="badge bg-danger">Admin</span></strong>
                        <ul class="small mt-2">
                            <li>All Staff permissions</li>
                            <li>Manage users</li>
                            <li>System settings</li>
                            <li>Google Sheets sync</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
