{% extends "base.html" %}

{% block title %}Loaner Swap - School Inventory System{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col">
        <h2><i class="bi bi-arrow-left-right"></i> Loaner Swap</h2>
        <p class="text-muted">Check in a broken item and simultaneously check out a loaner</p>
    </div>
    <div class="col text-end">
        <a href="{{ url_for('dashboard') }}" class="btn btn-secondary">
            <i class="bi bi-x"></i> Cancel
        </a>
    </div>
</div>

<div class="row">
    <div class="col-md-10 offset-md-1">
        <div class="card shadow-sm">
            <div class="card-body p-4">
                <form method="POST" id="swapForm">
                    <div class="row">
                        <!-- Left Column: Broken Asset (Check In) -->
                        <div class="col-md-6">
                            <div class="card border-danger mb-3">
                                <div class="card-header bg-danger text-white">
                                    <h5 class="mb-0"><i class="bi bi-box-arrow-in-left"></i> Check In (Broken)</h5>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label for="broken_asset_id" class="form-label">Select Broken Asset <span class="text-danger">*</span></label>
                                        <div class="position-relative">
                                            <input type="text"
                                                   class="form-control"
                                                   id="broken_asset_display"
                                                   placeholder="Search broken assets"
                                                   autocomplete="off"
                                                   required>
                                            <input type="hidden" id="broken_asset_id" name="broken_asset_id" required>
                                            <div class="dropdown-menu w-100 p-0" id="broken_asset_menu" style="max-height: 260px; overflow-y: auto;">
                                                {% for asset in checked_out_assets %}
                                                <button type="button"
                                                        class="dropdown-item asset-option"
                                                        data-for="broken"
                                                        data-id="{{ asset.id }}"
                                                        data-label="{{ asset.asset_tag }} - {{ asset.name }}{% if asset.current_checkout %} | Out: {{ asset.current_checkout.checked_out_to }}{% endif %}"
                                                        data-tag="{{ asset.asset_tag }}"
                                                        data-name="{{ asset.name }}"
                                                        data-type="{{ asset.type }}"
                                                        data-checkout-to="{{ asset.current_checkout.checked_out_to if asset.current_checkout else '' }}"
                                                        data-search="{{ (asset.asset_tag ~ ' ' ~ asset.name ~ ' ' ~ (asset.current_checkout.checked_out_to if asset.current_checkout else ''))|lower }}">
                                                    {{ asset.asset_tag }} - {{ asset.name }}
                                                    {% if asset.current_checkout %}
                                                    ({{ asset.current_checkout.checked_out_to }})
                                                    {% endif %}
                                                </button>
                                                {% endfor %}
                                                <div class="dropdown-item text-muted d-none" id="broken_asset_empty">No matching assets</div>
                                            </div>
                                        </div>
                                        {% if not checked_out_assets %}
                                        <div class="alert alert-info mt-2 mb-0">
                                            No assets are currently checked out.
                                        </div>
                                        {% endif %}
                                    </div>

                                    <div id="broken-info" class="alert alert-light" style="display: none;">
                                        <h6 class="mb-2">Asset Information:</h6>
                                        <p class="mb-1"><strong>Tag:</strong> <span id="broken-tag">-</span></p>
                                        <p class="mb-1"><strong>Name:</strong> <span id="broken-name">-</span></p>
                                        <p class="mb-1"><strong>Type:</strong> <span id="broken-type">-</span></p>
                                        <p class="mb-0"><strong>Checked out to:</strong> <span id="broken-checkout-to">-</span></p>
                                    </div>

                                    <div class="mb-3">
                                        <label for="checkin_notes" class="form-label">Issue Description</label>
                                        <textarea class="form-control" id="checkin_notes" name="checkin_notes" rows="3"
                                                  placeholder="Describe what's wrong with the device..."></textarea>
                                        <small class="form-text text-muted">What issue requires a loaner swap?</small>
                                    </div>

                                    <div class="alert alert-warning mb-0">
                                        <i class="bi bi-exclamation-triangle"></i> Asset will be marked as <strong>"needs_repair"</strong> and moved to <strong>"maintenance"</strong> status.
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Right Column: Loaner Asset (Check Out) -->
                        <div class="col-md-6">
                            <div class="card border-success mb-3">
                                <div class="card-header bg-success text-white">
                                    <h5 class="mb-0"><i class="bi bi-box-arrow-right"></i> Check Out (Loaner)</h5>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label for="loaner_asset_id" class="form-label">Select Loaner <span class="text-danger">*</span></label>
                                        <div class="position-relative">
                                            <input type="text"
                                                   class="form-control"
                                                   id="loaner_asset_display"
                                                   placeholder="Search loaner assets"
                                                   autocomplete="off"
                                                   required>
                                            <input type="hidden" id="loaner_asset_id" name="loaner_asset_id" required>
                                            <div class="dropdown-menu w-100 p-0" id="loaner_asset_menu" style="max-height: 260px; overflow-y: auto;">
                                                {% for asset in available_assets %}
                                                <button type="button"
                                                        class="dropdown-item asset-option"
                                                        data-for="loaner"
                                                        data-id="{{ asset.id }}"
                                                        data-label="{{ asset.asset_tag }} - {{ asset.name }} ({{ asset.condition }})"
                                                        data-tag="{{ asset.asset_tag }}"
                                                        data-name="{{ asset.name }}"
                                                        data-type="{{ asset.type }}"
                                                        data-condition="{{ asset.condition }}"
                                                        data-search="{{ (asset.asset_tag ~ ' ' ~ asset.name ~ ' ' ~ asset.type ~ ' ' ~ asset.condition)|lower }}">
                                                    {{ asset.asset_tag }} - {{ asset.name }} ({{ asset.condition }})
                                                </button>
                                                {% endfor %}
                                                <div class="dropdown-item text-muted d-none" id="loaner_asset_empty">No matching assets</div>
                                            </div>
                                        </div>
                                        {% if not available_assets %}
                                        <div class="alert alert-danger mt-2 mb-0">
                                            No loaner assets are available!
                                        </div>
                                        {% endif %}
                                    </div>

                                    <div id="loaner-info" class="alert alert-light" style="display: none;">
                                        <h6 class="mb-2">Loaner Information:</h6>
                                        <p class="mb-1"><strong>Tag:</strong> <span id="loaner-tag">-</span></p>
                                        <p class="mb-1"><strong>Name:</strong> <span id="loaner-name">-</span></p>
                                        <p class="mb-1"><strong>Type:</strong> <span id="loaner-type">-</span></p>
                                        <p class="mb-0"><strong>Condition:</strong> <span id="loaner-condition">-</span></p>
                                    </div>

                                    <div id="swap-warning" class="alert alert-warning" style="display: none;">
                                        <i class="bi bi-exclamation-triangle"></i> <strong>Type mismatch!</strong> The loaner type doesn't match the broken asset type.
                                    </div>

                                    <div class="alert alert-info mb-0">
                                        <i class="bi bi-info-circle"></i> Loaner will be checked out to the same person with the same expected return date.
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Swap Summary -->
                    <div id="swap-summary" class="card bg-light mb-3" style="display: none;">
                        <div class="card-body">
                            <h5 class="card-title"><i class="bi bi-arrow-left-right"></i> Swap Summary</h5>
                            <div class="row">
                                <div class="col-md-6">
                                    <p class="mb-0"><strong>Person:</strong> <span id="summary-person">-</span></p>
                                </div>
                                <div class="col-md-6">
                                    <p class="mb-0">
                                        <span id="summary-broken-tag" class="badge bg-danger">-</span>
                                        <i class="bi bi-arrow-right"></i>
                                        <span id="summary-loaner-tag" class="badge bg-success">-</span>
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Submit Button -->
                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-primary btn-lg" id="submitBtn" disabled>
                            <i class="bi bi-arrow-left-right"></i> Perform Loaner Swap
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Help Card -->
        <div class="card mt-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-question-circle"></i> How Loaner Swap Works</h5>
            </div>
            <div class="card-body">
                <ol class="mb-0">
                    <li><strong>Check In Broken Asset:</strong> The broken/malfunctioning asset is checked in with condition "needs_repair" and status "maintenance".</li>
                    <li><strong>Check Out Loaner:</strong> A replacement loaner asset is checked out to the same person.</li>
                    <li><strong>Maintains Continuity:</strong> The expected return date is carried over to the loaner checkout.</li>
                    <li><strong>One Transaction:</strong> Both operations happen atomically - if either fails, neither happens.</li>
                </ol>
            </div>
        </div>
    </div>
</div>

<script>
function updateSwapInfo(selectedBroken) {
    const brokenInfo = document.getElementById('broken-info');

    if (selectedBroken && selectedBroken.dataset.id) {
        document.getElementById('broken-tag').textContent = selectedBroken.dataset.tag || '-';
        document.getElementById('broken-name').textContent = selectedBroken.dataset.name || '-';
        document.getElementById('broken-type').textContent = selectedBroken.dataset.type || '-';
        document.getElementById('broken-checkout-to').textContent = selectedBroken.dataset.checkoutTo || '-';
        brokenInfo.style.display = 'block';
    } else {
        brokenInfo.style.display = 'none';
    }

    updateSubmitButton();
    updateSwapSummary();
}

function updateLoanerInfo(selectedLoaner) {
    const loanerInfo = document.getElementById('loaner-info');

    if (selectedLoaner && selectedLoaner.dataset.id) {
        document.getElementById('loaner-tag').textContent = selectedLoaner.dataset.tag || '-';
        document.getElementById('loaner-name').textContent = selectedLoaner.dataset.name || '-';
        document.getElementById('loaner-type').textContent = selectedLoaner.dataset.type || '-';
        document.getElementById('loaner-condition').textContent = selectedLoaner.dataset.condition || '-';
        loanerInfo.style.display = 'block';
    } else {
        loanerInfo.style.display = 'none';
    }

    checkTypeMatch();
    updateSubmitButton();
    updateSwapSummary();
}

function checkTypeMatch() {
    const brokenSelect = document.getElementById('broken_asset_id');
    const loanerSelect = document.getElementById('loaner_asset_id');
    const selectedBroken = document.querySelector('.asset-option.selected[data-for="broken"]');
    const selectedLoaner = document.querySelector('.asset-option.selected[data-for="loaner"]');
    const warning = document.getElementById('swap-warning');

    if (brokenSelect.value && loanerSelect.value && selectedBroken && selectedLoaner) {
        const brokenType = selectedBroken.dataset.type;
        const loanerType = selectedLoaner.dataset.type;

        if (brokenType !== loanerType) {
            warning.style.display = 'block';
        } else {
            warning.style.display = 'none';
        }
    } else {
        warning.style.display = 'none';
    }
}

function updateSubmitButton() {
    const brokenSelect = document.getElementById('broken_asset_id');
    const loanerSelect = document.getElementById('loaner_asset_id');
    const submitBtn = document.getElementById('submitBtn');

    if (brokenSelect.value && loanerSelect.value) {
        submitBtn.disabled = false;
    } else {
        submitBtn.disabled = true;
    }
}

function updateSwapSummary() {
    const brokenSelect = document.getElementById('broken_asset_id');
    const loanerSelect = document.getElementById('loaner_asset_id');
    const selectedBroken = document.querySelector('.asset-option.selected[data-for="broken"]');
    const selectedLoaner = document.querySelector('.asset-option.selected[data-for="loaner"]');
    const summary = document.getElementById('swap-summary');

    if (brokenSelect.value && loanerSelect.value && selectedBroken && selectedLoaner) {
        document.getElementById('summary-person').textContent = selectedBroken.dataset.checkoutTo || '-';
        document.getElementById('summary-broken-tag').textContent = selectedBroken.dataset.tag || '-';
        document.getElementById('summary-loaner-tag').textContent = selectedLoaner.dataset.tag || '-';
        summary.style.display = 'block';
    } else {
        summary.style.display = 'none';
    }
}

function setupAssetSearch(type) {
    const display = document.getElementById(type + '_asset_display');
    const hidden = document.getElementById(type + '_asset_id');
    const menu = document.getElementById(type + '_asset_menu');
    const empty = document.getElementById(type + '_asset_empty');
    if (!display || !hidden || !menu || !empty) return;

    const options = Array.from(menu.querySelectorAll('.asset-option'));

    function showMenu() {
        menu.classList.add('show');
    }

    function hideMenu() {
        menu.classList.remove('show');
    }

    function filterOptions() {
        const term = display.value.trim().toLowerCase();
        let visible = 0;
        options.forEach(function(option) {
            const text = option.dataset.search || '';
            const matched = !term || text.includes(term);
            option.classList.toggle('d-none', !matched);
            if (matched) visible += 1;
        });
        empty.classList.toggle('d-none', visible !== 0);
    }

    display.addEventListener('focus', function() {
        showMenu();
        filterOptions();
    });

    display.addEventListener('click', function() {
        showMenu();
        filterOptions();
    });

    display.addEventListener('input', function() {
        hidden.value = '';
        options.forEach(option => option.classList.remove('selected'));
        showMenu();
        filterOptions();
        updateSubmitButton();
        updateSwapSummary();
    });

    options.forEach(function(option) {
        option.addEventListener('click', function() {
            options.forEach(opt => opt.classList.remove('selected'));
            option.classList.add('selected');
            display.value = option.dataset.label || option.textContent.trim();
            hidden.value = option.dataset.id || '';
            hideMenu();
            if (type === 'broken') {
                updateSwapInfo(option);
            } else {
                updateLoanerInfo(option);
            }
        });
    });
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    setupAssetSearch('broken');
    setupAssetSearch('loaner');
    document.addEventListener('click', function(event) {
        ['broken', 'loaner'].forEach(function(type) {
            const display = document.getElementById(type + '_asset_display');
            const menu = document.getElementById(type + '_asset_menu');
            if (!display || !menu) return;
            const clickedInside = display.contains(event.target) || menu.contains(event.target);
            if (!clickedInside) {
                menu.classList.remove('show');
            }
        });
    });
});
</script>
{% endblock %}
